<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>个人中心</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>

        body {
            background: #f7faff;
        }
        .profile-banner {
            background: linear-gradient(120deg,#fcb900 0,#ff758c 100%);
            padding: 2.2rem 0 1rem 0;
            border-radius: 0 0 40px 40px;
            color: #fff;
            text-align: center;
            margin-bottom: 2.2rem;
            box-shadow: 0 4px 32px rgba(240,150,120,0.10);
        }
        .profile-banner h2 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: .7rem;
            letter-spacing: .03em;
        }
        .profile-banner .sub {
            font-size: 1.11rem;
            color: #ffe6c6;
            margin-bottom: .1rem;
        }

        .profile-container {
            max-width: 1250px;
            margin: auto;
            padding: 0 20px 40px;
        }
        .main-grid {
            display: grid;
            grid-template-columns: 370px 1fr;
            gap: 2.1rem;
        }

        .card {
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 6px 32px rgba(60,72,88,0.10);
            border: none;
            margin-bottom: 1.7rem;
            transition: box-shadow 0.2s;
        }
        .card-header {
            background: linear-gradient(100deg,#6c757d,#495057 80%);
            color: #fff;
            font-size: 1.19rem;
            font-weight: 700;
            padding: 1.08rem 1.7rem;
            border-radius: 18px 18px 0 0;
        }
        .card-body {
            padding: 2.1rem 1.5rem 1.5rem;
        }
        /* 头像动画边框 */
        .avatar-section {
            text-align: center;
            margin-bottom: 1.4rem;
            position: relative;
        }
        .rounded-circle {
            width: 118px;
            height: 118px;
            border: 5px solid #fcb900;
            box-shadow: 0 2px 8px rgba(240,170,100,0.14);
            transition: box-shadow .22s;
            background: #fff;
        }
        .rounded-circle:hover {
            box-shadow: 0 7px 18px rgba(255,130,100,0.16);
        }
        .profile-badge {
            position: absolute;
            right: 22%;
            bottom: 12%;
            background: linear-gradient(135deg,#fdc830,#f37335 60%);
            color: #fff;
            border-radius: 50%;
            padding: 0.36rem 0.52rem;
            font-size: 1rem;
            border: 2px solid #fff;
        }
        .form-label { font-weight: 700; }
        .btn-group { display: flex; justify-content: flex-end; gap: 1.2rem; }
        .btn {
            border-radius: 22px;
            font-weight: 700;
            padding: 0.72rem 2rem;
            transition: background .18s, color .18s, box-shadow .16s;
        }
        .btn-primary { background: #3e7bfd; color: #fff; }
        .btn-primary:hover { background: #0051ff; }
        .btn-warning { background: #ffc107; color: #fff;}
        .btn-warning:hover { background: #fcb900; color: #fff;}
        /* 统计卡片动效 */
        .stat-card {
            background: linear-gradient(100deg,#f1f5fd 0,#fff9eb 100%);
            border-radius: 14px;
            padding: .97rem 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(90,110,160,0.07);
            transition: box-shadow .17s;
            position: relative;
        }
        .stat-value { font-size: 1.25rem; font-weight: 800; color: #fa8900;}
        .stat-label { font-size: 0.98rem; color: #7a8ca5; }
        .stat-card .fa {
            font-size: 1.3em;
            margin-right: .22em;
        }

        .chart-container {
            flex: 1;
            background: #fff6ec;
            border-radius: 13px;
            padding: 0.8rem 0.5rem;
            box-shadow: 0 1px 8px rgba(62,90,250,0.05);
            height: 180px;
            display: flex;
            flex-direction: column;
        }
        .chart-title { font-size: 0.99rem; font-weight: 600; margin-bottom: 0.3rem; color: #fd7e14;}
        #interactionChart { flex: 1; }
        .articles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(270px,1fr)); gap: 1.7rem; }
        .article-section {
            background: #fffbe9;
            border-radius: 13px;
            padding: 1.2rem;
            box-shadow: 0 2px 10px rgba(254,179,68,0.08);
        }
        .article-section h5 { font-size: 1.08rem; margin-bottom: 1rem; color: #fa8900;}
        .article-list li { padding: 0.8rem 0; border-bottom: 1px solid #f0f0f5; }
        .article-list li:last-child { border-bottom: none; }
        @media (max-width:900px) {
            .main-grid { grid-template-columns: 1fr; }
        }
        @media (max-width:650px) {
            .profile-container { padding: 0 5px 18px;}
            .card { border-radius: 10px;}
        }
    </style>
</head>
<body>

<div th:insert="~{nav.html}"></div>

<section class="profile-banner">
    <h2>Hi, <span th:text="${user.nickname}">用户名</span>！</h2>
    <p class="lead">欢迎来到专属个人空间，管理您的文章，发现成长！</p>
</section>

<div class="container mb-5">
    <div class="row g-4">
        <!-- 左侧：个人信息 & 安全 -->
        <div class="col-lg-4">
            <div class="card mb-4 shadow-sm text-center">
                <div class="card-body">
                    <img th:src="@{${userAvatarUrl}}" class="avatar-lg mb-3" alt="头像">
                    <h5 class="card-title" th:text="${user.nickname}">昵称</h5>
                    <p class="text-muted mb-3" th:text="${user.bio ?: '这位同学很懒，什么都没留下'}">个人简介</p>
                    <div class="d-flex justify-content-center gap-4 mb-3">
                        <div>
                            <h6 th:text="${followerCount}">0</h6>
                            <small class="text-muted">粉丝</small>
                        </div>
                        <div>
                            <h6 th:text="${followingCount}">0</h6>
                            <small class="text-muted">关注</small>
                        </div>
                    </div>
                    <button class="btn btn-outline-light btn-sm" data-bs-toggle="modal" data-bs-target="#editInfoModal">
                        <i class="bi bi-pencil-square me-1"></i> 编辑信息
                    </button>
                </div>
            </div>
            <div class="card shadow-sm">
                <div class="card-header bg-white">账户安全</div>
                <div class="card-body">
                    <form th:action="@{/profile/password}" method="post">
                        <div class="mb-3">
                            <label class="form-label">当前密码</label>
                            <input type="password" name="oldPassword" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">新密码</label>
                            <input type="password" name="newPassword" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">确认密码</label>
                            <input type="password" name="confirmPassword" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">
                            <i class="bi bi-shield-lock me-1"></i> 更新密码
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 右侧：统计 & 列表 -->
        <div class="col-lg-8">
            <!-- 统计卡片 -->
            <div class="row gy-3 mb-4">
                <div class="col-md-4">
                    <div class="card stats-card p-3 text-center shadow-sm">
                        <i class="bi bi-hand-thumbs-up fs-2 text-primary"></i>
                        <h4 class="mt-2" th:text="${likeCount}">0</h4>
                        <small class="text-muted">点赞总数</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card p-3 text-center shadow-sm">
                        <i class="bi bi-bookmark-star fs-2 text-success"></i>
                        <h4 class="mt-2" th:text="${favoriteCount}">0</h4>
                        <small class="text-muted">收藏总数</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card stats-card p-3 text-center shadow-sm">
                        <i class="bi bi-eye fs-2 text-warning"></i>
                        <h4 class="mt-2" th:text="${viewCount}">0</h4>
                        <small class="text-muted">浏览总数</small>
                    </div>
                </div>
            </div>

            <!-- 文章列表标签页 -->
            <ul class="nav nav-tabs mb-3" id="profileTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-published">已发布</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-liked">我点赞的</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-favorited">我收藏的</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pending">待审核</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-draft">草稿箱</button></li>
            </ul>

            <div class="tab-content">
                <!-- 已发布 -->
                <div class="tab-pane fade show active" id="tab-published">
                    <div class="list-group">
                        <a th:each="a : ${publishedArticles}"
                           th:href="@{/articles/{id}(id=${a.id})}"
                           class="list-group-item list-group-item-action d-flex justify-content-between">
                            <span th:text="${a.title}">文章标题</span>
                            <small class="text-muted" th:text="${#dates.format(a.createdAt,'yyyy-MM-dd')}">日期</small>
                        </a>
                        <div th:if="${#lists.isEmpty(publishedArticles)}" class="py-3 text-center text-muted">
                            暂无已发布文章
                        </div>
                    </div>
                </div>
                <!-- 我点赞的 -->
                <div class="tab-pane fade" id="tab-liked">
                    <div class="list-group">
                        <a th:each="a : ${likedArticles}"
                           th:href="@{/articles/{id}(id=${a.id})}"
                           class="list-group-item list-group-item-action">
                            <i class="bi bi-hand-thumbs-up-fill text-primary me-2"></i>
                            <span th:text="${a.title}">文章标题</span>
                        </a>
                        <div th:if="${#lists.isEmpty(likedArticles)}" class="py-3 text-center text-muted">
                            暂无点赞记录
                        </div>
                    </div>
                </div>
                <!-- 我收藏的 -->
                <div class="tab-pane fade" id="tab-favorited">
                    <div class="list-group">
                        <a th:each="a : ${favoritedArticles}"
                           th:href="@{/articles/{id}(id=${a.id})}"
                           class="list-group-item list-group-item-action">
                            <i class="bi bi-bookmark-fill text-success me-2"></i>
                            <span th:text="${a.title}">文章标题</span>
                        </a>
                        <div th:if="${#lists.isEmpty(favoritedArticles)}" class="py-3 text-center text-muted">
                            暂无收藏记录
                        </div>
                    </div>
                </div>
                <!-- 待审核 -->
                <div class="tab-pane fade" id="tab-pending">
                    <div class="list-group">
                        <div th:each="a : ${pendingArticles}" class="list-group-item d-flex justify-content-between">
                            <span th:text="${a.title}">文章标题</span>
                            <span class="badge bg-warning">审核中</span>
                        </div>
                        <div th:if="${#lists.isEmpty(pendingArticles)}" class="py-3 text-center text-muted">
                            暂无待审核文章
                        </div>
                    </div>
                </div>
                <!-- 草稿箱 -->
                <div class="tab-pane fade" id="tab-draft">
                    <div class="list-group">
                        <div th:each="a : ${draftArticles}" class="list-group-item d-flex justify-content-between">
                            <span th:text="${a.title}">草稿标题</span>
                            <a th:href="@{/articles/edit/{id}(id=${a.id})}" class="btn btn-outline-secondary btn-sm">编辑</a>
                        </div>
                        <div th:if="${#lists.isEmpty(draftArticles)}" class="py-3 text-center text-muted">
                            暂无草稿
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- 编辑信息 Modal -->
<div class="modal fade" id="editInfoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form th:action="@{/profile/info}" method="post" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">编辑个人信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <img th:src="@{${userAvatarUrl}}" class="avatar-lg mb-2" alt="头像">
                        <input type="file" name="avatar" class="form-control form-control-sm">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">昵称</label>
                        <input type="text" name="nickname" class="form-control" th:value="${user.nickname}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">个人简介</label>
                        <textarea name="bio" class="form-control" rows="3" th:text="${user.bio}"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    $(function(){
        $('#avatarInput').on('change', function(){
            const file = this.files[0];
            if (!file) return $('#previewBox').hide();
            const reader = new FileReader();
            reader.onload = e => {
                $('#previewAvatar').attr('src', e.target.result);
                $('#previewBox').show();
            };
            reader.readAsDataURL(file);
        });

        $('#profileForm').on('submit', function(e){
            e.preventDefault();
            const form = this;
            const data = new FormData(form);
            $.ajax({
                url: form.action,
                type: 'POST',
                data: data,
                cache: false,
                contentType: false,
                processData: false,
                headers: {'X-Requested-With':'XMLHttpRequest'},
                success(res) {
                    if (res.success) {
                        $('#msgBox').html('<div class="alert alert-success">个人信息更新成功！</div>');
                        $('#previewBox').hide();
                        $('img.rounded-circle').attr('src', res.avatar_url);
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        $('#msgBox').html('<div class="alert alert-danger">更新失败：' + (res.error || '未知错误') + '</div>');
                    }
                },
                error() {
                    $('#msgBox').html('<div class="alert alert-danger">服务器连接错误，请稍后重试</div>');
                }
            });
        });

        // 折线图实现
        const ctx = document.getElementById('interactionChart').getContext('2d');
        let interactionChart;
        let currentPeriod = 'week';

        // 初始化图表
        function initChart(labels, likes, favorites, views) {
            if (interactionChart) {
                interactionChart.destroy();
            }

            interactionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '点赞数',
                            data: likes,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '收藏数',
                            data: favorites,
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: '浏览量',
                            data: views,
                            borderColor: '#fd7e14',
                            backgroundColor: 'rgba(253, 126, 20, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 15,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                precision: 0
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // 加载统计数据
        function loadChartData(period) {
            $('.chart-btn').removeClass('active');
            $(`.chart-btn[data-period="${period}"]`).addClass('active');

            // 显示加载状态
            $('#interactionChart').hide();
            $('.chart-container').append('<div id="chartLoading" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">加载数据中...</p></div>');

            $.ajax({
                url: '/personblog/profile/stats?days=7',
                type: 'GET',
                success: function(res) {
                    if (res.success) {
                        const data = res.data;
                        initChart(data.labels, data.likes, data.favorites, data.views);
                        currentPeriod = period;
                    } else {
                        alert('加载数据失败: ' + res.error);
                    }
                },
                error: function() {
                    alert('服务器连接错误，请稍后重试');
                },
                complete: function() {
                    $('#chartLoading').remove();
                    $('#interactionChart').show();
                }
            });
        }

        // 初始加载数据
        loadChartData(7);


    });
</script>
</body>
</html>